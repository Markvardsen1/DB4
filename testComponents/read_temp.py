from machine import Pin
from machine import ADC
from machine import DAC
from math import log

import machine
import utime

adc_V_lookup = [1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.062353, 1.068529, 1.037647, 1.031471, 0.9511765, 0.8894118, 0.8400001, 0.9388236, 0.735, 0.6670588, 0.8461765, 0.5558824, 0.5188236, 0.7844118, 0.4261765, 0.3644118, 0.3088235, 0.6608824, 0.1729412, 0.1111765, 0.5929412, 0.01235294, 0.3870588, 0.7741177, 1.161177, 1.164265, 1.167353, 1.170441, 1.179706, 1.178471, 1.183412, 1.188353, 1.193294, 1.198235, 1.202353, 1.206471, 1.210588, 1.213059, 1.215529, 1.218, 1.220471, 1.222941, 1.227059, 1.231176, 1.235294, 1.239412, 1.243529, 1.247647, 1.250735, 1.253824, 1.256912, 1.26, 1.263088, 1.266176, 1.269265, 1.272353, 1.275441, 1.278529, 1.281618, 1.284706, 1.288824, 1.292941, 1.297059, 1.300147, 1.303235, 1.306324, 1.309412, 1.313529, 1.317647, 1.321765, 1.324235, 1.326706, 1.329177, 1.331647, 1.334118, 1.336588, 1.339059, 1.341529, 1.344, 1.346471, 1.350588, 1.354706, 1.358824, 1.362941, 1.367059, 1.371176, 1.373647, 1.376118, 1.378588, 1.381059, 1.383529, 1.386, 1.388471, 1.390941, 1.393412, 1.395882, 1.4, 1.404118, 1.408235, 1.411324, 1.414412, 1.4175, 1.420588, 1.424706, 1.428824, 1.432941, 1.436029, 1.439118, 1.442206, 1.445294, 1.448382, 1.451471, 1.454559, 1.457647, 1.461765, 1.465882, 1.47, 1.472471, 1.474941, 1.477412, 1.479882, 1.482353, 1.486471, 1.490588, 1.494706, 1.497794, 1.500882, 1.503971, 1.507059, 1.510147, 1.513235, 1.516324, 1.519412, 1.5225, 1.525588, 1.528677, 1.531765, 1.535882, 1.54, 1.544118, 1.547206, 1.550294, 1.553382, 1.556471, 1.559559, 1.562647, 1.565735, 1.568824, 1.570368, 1.571912, 1.573456, 1.575, 1.576544, 1.578088, 1.579632, 1.581177, 1.584265, 1.587353, 1.590441, 1.593529, 1.597647, 1.601765, 1.605882, 1.61, 1.614118, 1.618235, 1.621324, 1.624412, 1.6275, 1.630588, 1.633059, 1.635529, 1.638, 1.640471, 1.642941, 1.647059, 1.651177, 1.655294, 1.659412, 1.663529, 1.667647, 1.670735, 1.673824, 1.676912, 1.68, 1.683088, 1.686177, 1.689265, 1.692353, 1.695441, 1.698529, 1.701618, 1.704706, 1.707176, 1.709647, 1.712118, 1.714588, 1.717059, 1.721177, 1.725294, 1.729412, 1.733529, 1.737647, 1.741765, 1.744235, 1.746706, 1.749177, 1.751647, 1.754118, 1.757206, 1.760294, 1.763382, 1.766471, 1.76853, 1.770588, 1.772647, 1.774706, 1.776765, 1.778824, 1.781912, 1.785, 1.788088, 1.791177, 1.797353, 1.80353, 1.806, 1.808471, 1.810941, 1.813412, 1.815882, 1.822059, 1.828235, 1.831324, 1.834412, 1.8375, 1.840588, 1.844706, 1.848824, 1.852941, 1.85603, 1.859118, 1.862206, 1.865294, 1.867765, 1.870235, 1.872706, 1.875177, 1.877647, 1.880735, 1.883824, 1.886912, 1.89, 1.894118, 1.898235, 1.902353, 1.905441, 1.908529, 1.911618, 1.914706, 1.918823, 1.922941, 1.927059, 1.930147, 1.933235, 1.936324, 1.939412, 1.9425, 1.945588, 1.948677, 1.951765, 1.954853, 1.957941, 1.96103, 1.970294, 1.970294, 1.976471, 1.982647, 1.988824, 1.992941, 1.997059, 2.001177, 2.003647, 2.006118, 2.008588, 2.011059, 2.01353, 2.017647, 2.021765, 2.025882, 2.03, 2.034118, 2.038235, 2.040294, 2.042353, 2.044412, 2.046471, 2.048529, 2.050588, 2.053677, 2.056765, 2.059853, 2.062941, 2.067059, 2.071177, 2.075294, 2.078382, 2.081471, 2.084559, 2.087647, 2.090735, 2.093824, 2.096912, 2.1, 2.106177, 2.112353, 2.114824, 2.117294, 2.119765, 2.122235, 2.124706, 2.128824, 2.132941, 2.137059, 2.143235, 2.149412, 2.151882, 2.154353, 2.156824, 2.159294, 2.161765, 2.163824, 2.165882, 2.167941, 2.17, 2.172059, 2.174118, 2.176177, 2.178235, 2.180294, 2.182353, 2.184412, 2.186471, 2.190588, 2.194706, 2.198824, 2.201912, 2.205, 2.208088, 2.211177, 2.217353, 2.22353, 2.226618, 2.229706, 2.232794, 2.235883, 2.238353, 2.240824, 2.243294, 2.245765, 2.248235, 2.254412, 2.260588, 2.262647, 2.264706, 2.266765, 2.268824, 2.270882, 2.272941, 2.277059, 2.281177, 2.285294, 2.287765, 2.290235, 2.292706, 2.295177, 2.297647, 2.301765, 2.305882, 2.31, 2.314118, 2.318235, 2.322353, 2.325441, 2.32853, 2.331618, 2.334706, 2.337794, 2.340883, 2.343971, 2.347059, 2.350147, 2.353235, 2.356324, 2.359412, 2.361882, 2.364353, 2.366824, 2.369294, 2.371765, 2.377941, 2.384118, 2.386588, 2.389059, 2.39153, 2.394, 2.396471, 2.400588, 2.404706, 2.408823, 2.412941, 2.417059, 2.421176, 2.424265, 2.427353, 2.430441, 2.433529, 2.436, 2.438471, 2.440941, 2.443412, 2.445882, 2.448971, 2.452059, 2.455147, 2.458235, 2.460706, 2.463176, 2.465647, 2.468118, 2.470588, 2.474706, 2.478824, 2.482941, 2.486029, 2.489118, 2.492206, 2.495294, 2.497765, 2.500235, 2.502706, 2.505177, 2.507647, 2.513824, 2.52, 2.522059, 2.524118, 2.526176, 2.528235, 2.530294, 2.532353, 2.536471, 2.540588, 2.544706, 2.547177, 2.549647, 2.552118, 2.554588, 2.557059, 2.558603, 2.560147, 2.561691, 2.563235, 2.56478, 2.566324, 2.567868, 2.569412, 2.5725, 2.575588, 2.578676, 2.581765, 2.587941, 2.594118, 2.596177, 2.598235, 2.600294, 2.602353, 2.604412, 2.606471, 2.610588, 2.614706, 2.618824, 2.621294, 2.623765, 2.626235, 2.628706, 2.631176, 2.634265, 2.637353, 2.640441, 2.643529, 2.646618, 2.649706, 2.652794, 2.655882, 2.657941, 2.66, 2.662059, 2.664118, 2.666177, 2.668235, 2.670706, 2.673177, 2.675647, 2.678118, 2.680588, 2.683676, 2.686765, 2.689853, 2.692941, 2.695412, 2.697882, 2.700353, 2.702824, 2.705294, 2.707765, 2.710235, 2.712706, 2.715177, 2.717647, 2.719706, 2.721765, 2.723824, 2.725883, 2.727941, 2.73, 2.734118, 2.738235, 2.742353, 2.744118, 2.745883, 2.747647, 2.749412, 2.751176, 2.752941, 2.754706, 2.767059, 2.770147, 2.773235, 2.776324, 2.779412, 2.781177, 2.782941, 2.784706, 2.786471, 2.788235, 2.79, 2.791765, 2.794853, 2.797941, 2.801029, 2.804118, 2.806588, 2.809059, 2.81153, 2.814, 2.816471, 2.81853, 2.820588, 2.822647, 2.824706, 2.826765, 2.828824, 2.830883, 2.832941, 2.835, 2.837059, 2.839118, 2.841177, 2.843647, 2.846118, 2.848588, 2.851059, 2.853529, 2.855588, 2.857647, 2.859706, 2.861765, 2.863824, 2.865882, 2.867647, 2.869412, 2.871177, 2.872941, 2.874706, 2.876471, 2.878235, 2.87978, 2.881324, 2.882868, 2.884412, 2.885956, 2.8875, 2.889044, 2.890588, 2.893059, 2.89553, 2.898, 2.900471, 2.902941, 2.905, 2.907059, 2.909118, 2.911177, 2.913235, 2.915294, 2.917765, 2.920235, 2.922706, 2.925177, 2.927647, 2.930118, 2.932588, 2.935059, 2.93753, 2.94, 2.941544, 2.943088, 2.944633, 2.946177, 2.947721, 2.949265, 2.950809, 2.952353, 2.953726, 2.955098, 2.956471, 2.957843, 2.959216, 2.960588, 2.961961, 2.963333, 2.964706, 2.966471, 2.968235, 2.97, 2.971765, 2.973529, 2.975294, 2.977059, 2.979529, 2.982, 2.984471, 2.986941, 2.989412, 2.990784, 2.992157, 2.99353, 2.994902, 2.996275, 2.997647, 2.99902, 3.000392, 3.001765, 3.003824, 3.005883, 3.007941, 3.01, 3.012059, 3.014118, 3.016588, 3.019059, 3.02153, 3.024, 3.026471, 3.028235, 3.03, 3.031765, 3.03353, 3.035294, 3.037059, 3.038824, 3.040196, 3.041569, 3.042941, 3.044314, 3.045686, 3.047059, 3.048431, 3.049804, 3.051177, 3.052941, 3.054706, 3.056471, 3.058235, 3.06, 3.061765, 3.063529, 3.065588, 3.067647, 3.069706, 3.071765, 3.073823, 3.075882, 3.077427, 3.078971, 3.080515, 3.082059, 3.083603, 3.085147, 3.086691, 3.088235, 3.09, 3.091765, 3.093529, 3.095294, 3.097059, 3.098824, 3.106765, 3.137647]

NOM_RES = 10000
SER_RES = 9820
TEMP_NOM = 25
NUM_SAMPLES = 25
THERM_B_COEFF = 3950
ADC_MAX = 1023
ADC_Vmax = 3.15

def init_temp_sensor(TENP_SENS_ADC_PIN_NO = 32):
    adc = ADC(Pin(TENP_SENS_ADC_PIN_NO))
    adc.atten(ADC.ATTN_11DB)
    adc.width(ADC.WIDTH_10BIT)
    return adc

def read_temp(temp_sens):
    raw_read = []
    # Collect NUM_SAMPLES
    for i in range(1, NUM_SAMPLES+1):
        raw_read.append(temp_sens.read())

    # Average of the NUM_SAMPLES and look it up in the table
    raw_average = sum(raw_read)/NUM_SAMPLES
    print('raw_avg = ' + str(raw_average))
    print('V_measured = ' + str(adc_V_lookup[round(raw_average)]))

    # Convert to resistance
    raw_average = ADC_MAX * adc_V_lookup[round(raw_average)]/ADC_Vmax
    resistance = (SER_RES * raw_average) / (ADC_MAX - raw_average)
    print('Thermistor resistance: {} ohms'.format(resistance))

    # Convert to temperature
    steinhart  = log(resistance / NOM_RES) / THERM_B_COEFF
    steinhart += 1.0 / (TEMP_NOM + 273.15)
    steinhart  = (1.0 / steinhart) - 273.15
    return steinhart

print("I'm alive!\n")
utime.sleep_ms(2000)

temp_sens = init_temp_sensor()

sample_last_ms = 0
SAMPLE_INTERVAL = 1000

while (True):
    if utime.ticks_diff(utime.ticks_ms(), sample_last_ms) >= SAMPLE_INTERVAL:
        temp = read_temp(temp_sens)
        print('Thermistor temperature: ' + str(temp))
        sample_last_ms = utime.ticks_ms()
