from machine import Pin
from machine import ADC
from machine import DAC
from math import log

import machine
import utime

adc_V_lookup = [0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9635295, 0.9882354, 0.9758824, 0.9017648, 0.9202942, 0.8029412, 0.7597059, 0.6917647, 0.8214706, 0.5744118, 0.537353, 0.7535295, 0.4138236, 0.3767647, 0.6732353, 0.2841177, 0.2161765, 0.1791177, 0.5867648, 0.06794118, 0.006176471, 0.5497059, 1.099412, 1.1025, 1.105588, 1.108677, 1.111765, 1.115882, 1.12, 1.124118, 1.128235, 1.132353, 1.136471, 1.139559, 1.142647, 1.145735, 1.148824, 1.151912, 1.155, 1.158088, 1.161177, 1.165294, 1.169412, 1.17353, 1.177647, 1.181765, 1.185882, 1.19, 1.194118, 1.198235, 1.201324, 1.204412, 1.2075, 1.210588, 1.213676, 1.216765, 1.219853, 1.222941, 1.229118, 1.235294, 1.237765, 1.240235, 1.242706, 1.245177, 1.247647, 1.251765, 1.255882, 1.26, 1.262471, 1.264941, 1.267412, 1.269882, 1.272353, 1.275441, 1.278529, 1.281618, 1.284706, 1.288824, 1.292941, 1.297059, 1.301177, 1.305294, 1.309412, 1.311882, 1.314353, 1.316824, 1.319294, 1.321765, 1.327941, 1.334118, 1.338235, 1.342353, 1.346471, 1.348235, 1.35, 1.351765, 1.353529, 1.355294, 1.357059, 1.358824, 1.362941, 1.367059, 1.371176, 1.374265, 1.377353, 1.380441, 1.383529, 1.387647, 1.391765, 1.395882, 1.4, 1.404118, 1.408235, 1.411324, 1.414412, 1.4175, 1.420588, 1.423676, 1.426765, 1.429853, 1.432941, 1.437059, 1.441177, 1.445294, 1.448382, 1.451471, 1.454559, 1.457647, 1.460735, 1.463824, 1.466912, 1.47, 1.472471, 1.474941, 1.477412, 1.479882, 1.482353, 1.488529, 1.494706, 1.497794, 1.500882, 1.503971, 1.507059, 1.510147, 1.513235, 1.516324, 1.519412, 1.52353, 1.527647, 1.531765, 1.534853, 1.537941, 1.541029, 1.544118, 1.547206, 1.550294, 1.553382, 1.556471, 1.560588, 1.564706, 1.568824, 1.570368, 1.571912, 1.573456, 1.575, 1.576544, 1.578088, 1.579632, 1.581177, 1.584265, 1.587353, 1.590441, 1.593529, 1.597647, 1.601765, 1.605882, 1.61, 1.614118, 1.618235, 1.621324, 1.624412, 1.6275, 1.630588, 1.633677, 1.636765, 1.639853, 1.642941, 1.649118, 1.655294, 1.657353, 1.659412, 1.661471, 1.663529, 1.665588, 1.667647, 1.670735, 1.673824, 1.676912, 1.68, 1.686177, 1.692353, 1.694412, 1.696471, 1.698529, 1.700588, 1.702647, 1.704706, 1.710882, 1.717059, 1.721177, 1.725294, 1.729412, 1.7325, 1.735588, 1.738677, 1.741765, 1.744853, 1.747941, 1.751029, 1.754118, 1.758235, 1.762353, 1.766471, 1.769559, 1.772647, 1.775735, 1.778824, 1.780882, 1.782941, 1.785, 1.787059, 1.789118, 1.791177, 1.80353, 1.805588, 1.807647, 1.809706, 1.811765, 1.813824, 1.815882, 1.822059, 1.828235, 1.830706, 1.833177, 1.835647, 1.838118, 1.840588, 1.844706, 1.848824, 1.852941, 1.85603, 1.859118, 1.862206, 1.865294, 1.869412, 1.87353, 1.877647, 1.881765, 1.885882, 1.89, 1.892059, 1.894118, 1.896177, 1.898235, 1.900294, 1.902353, 1.908529, 1.914706, 1.916765, 1.918823, 1.920882, 1.922941, 1.925, 1.927059, 1.939412, 1.9425, 1.945588, 1.948677, 1.951765, 1.955882, 1.96, 1.964118, 1.968235, 1.972353, 1.976471, 1.980588, 1.984706, 1.988824, 1.992941, 1.997059, 2.001177, 2.003235, 2.005294, 2.007353, 2.009412, 2.011471, 2.01353, 2.017647, 2.021765, 2.025882, 2.03, 2.034118, 2.038235, 2.042353, 2.046471, 2.050588, 2.052647, 2.054706, 2.056765, 2.058824, 2.060882, 2.062941, 2.067059, 2.071177, 2.075294, 2.079412, 2.083529, 2.087647, 2.090735, 2.093824, 2.096912, 2.1, 2.103088, 2.106177, 2.109265, 2.112353, 2.116471, 2.120588, 2.124706, 2.128824, 2.132941, 2.137059, 2.141176, 2.145294, 2.149412, 2.153529, 2.157647, 2.161765, 2.164235, 2.166706, 2.169177, 2.171647, 2.174118, 2.177206, 2.180294, 2.183383, 2.186471, 2.190588, 2.194706, 2.198824, 2.201294, 2.203765, 2.206235, 2.208706, 2.211177, 2.215294, 2.219412, 2.22353, 2.226, 2.228471, 2.230941, 2.233412, 2.235883, 2.238971, 2.242059, 2.245147, 2.248235, 2.251324, 2.254412, 2.2575, 2.260588, 2.263677, 2.266765, 2.269853, 2.272941, 2.277059, 2.281177, 2.285294, 2.289412, 2.29353, 2.297647, 2.300118, 2.302588, 2.305059, 2.307529, 2.31, 2.313088, 2.316177, 2.319265, 2.322353, 2.326471, 2.330588, 2.334706, 2.337177, 2.339647, 2.342118, 2.344588, 2.347059, 2.353235, 2.359412, 2.361882, 2.364353, 2.366824, 2.369294, 2.371765, 2.374235, 2.376706, 2.379177, 2.381647, 2.384118, 2.388235, 2.392353, 2.396471, 2.400588, 2.404706, 2.408823, 2.411912, 2.415, 2.418088, 2.421176, 2.424265, 2.427353, 2.430441, 2.433529, 2.436618, 2.439706, 2.442794, 2.445882, 2.45, 2.454118, 2.458235, 2.460706, 2.463176, 2.465647, 2.468118, 2.470588, 2.473059, 2.475529, 2.478, 2.480471, 2.482941, 2.486029, 2.489118, 2.492206, 2.495294, 2.499412, 2.50353, 2.507647, 2.510735, 2.513824, 2.516912, 2.52, 2.523088, 2.526176, 2.529265, 2.532353, 2.535441, 2.538529, 2.541618, 2.544706, 2.547794, 2.550882, 2.553971, 2.557059, 2.561177, 2.565294, 2.569412, 2.571882, 2.574353, 2.576824, 2.579294, 2.581765, 2.585882, 2.59, 2.594118, 2.596177, 2.598235, 2.600294, 2.602353, 2.604412, 2.606471, 2.609559, 2.612647, 2.615735, 2.618824, 2.621294, 2.623765, 2.626235, 2.628706, 2.631176, 2.633647, 2.636118, 2.638588, 2.641059, 2.643529, 2.647647, 2.651765, 2.655882, 2.657941, 2.66, 2.662059, 2.664118, 2.666177, 2.668235, 2.671324, 2.674412, 2.6775, 2.680588, 2.683676, 2.686765, 2.689853, 2.692941, 2.696029, 2.699118, 2.702206, 2.705294, 2.709412, 2.71353, 2.717647, 2.71902, 2.720392, 2.721765, 2.723137, 2.72451, 2.725883, 2.727255, 2.728627, 2.73, 2.734118, 2.738235, 2.742353, 2.745441, 2.748529, 2.751618, 2.754706, 2.757176, 2.759647, 2.762118, 2.764588, 2.767059, 2.770147, 2.773235, 2.776324, 2.779412, 2.7825, 2.785588, 2.788677, 2.791765, 2.79353, 2.795294, 2.797059, 2.798824, 2.800588, 2.802353, 2.804118, 2.810294, 2.816471, 2.818235, 2.82, 2.821765, 2.823529, 2.825294, 2.827059, 2.828824, 2.830588, 2.832353, 2.834118, 2.835882, 2.837647, 2.839412, 2.841177, 2.843647, 2.846118, 2.848588, 2.851059, 2.853529, 2.856, 2.858471, 2.860941, 2.863412, 2.865882, 2.868353, 2.870824, 2.873294, 2.875765, 2.878235, 2.87978, 2.881324, 2.882868, 2.884412, 2.885956, 2.8875, 2.889044, 2.890588, 2.893059, 2.89553, 2.898, 2.900471, 2.902941, 2.907059, 2.911177, 2.915294, 2.91653, 2.917765, 2.919, 2.920235, 2.921471, 2.922706, 2.923941, 2.925177, 2.926412, 2.927647, 2.931765, 2.935883, 2.94, 2.942059, 2.944118, 2.946177, 2.948236, 2.950294, 2.952353, 2.953588, 2.954823, 2.956059, 2.957294, 2.958529, 2.959765, 2.961, 2.962235, 2.963471, 2.964706, 2.967794, 2.970882, 2.973971, 2.977059, 2.979529, 2.982, 2.984471, 2.986941, 2.989412, 2.990956, 2.9925, 2.994044, 2.995588, 2.997132, 2.998676, 3.000221, 3.001765, 3.003824, 3.005883, 3.007941, 3.01, 3.012059, 3.014118, 3.017206, 3.020294, 3.023382, 3.026471, 3.027843, 3.029216, 3.030588, 3.031961, 3.033334, 3.034706, 3.036078, 3.037451, 3.038824, 3.040196, 3.041569, 3.042941, 3.044314, 3.045686, 3.047059, 3.048431, 3.049804, 3.051177, 3.053647, 3.056118, 3.058589, 3.061059, 3.063529, 3.065074, 3.066618, 3.068162, 3.069706, 3.07125, 3.072794, 3.074338, 3.075882, 3.077647, 3.079412, 3.081177, 3.082941, 3.084706, 3.086471, 3.088235, 3.090294, 3.092353, 3.094412, 3.096471, 3.098529, 3.100588, 3.102647, 3.104706, 3.106765, 3.108824, 3.110882, 3.112941, 3.114706, 3.116471, 3.118235, 3.12, 3.121765, 3.12353, 3.125294, 3.129412, 3.13353, 3.137647, 3.138676, 3.139706, 3.140735, 3.141765, 3.142794, 3.143824, 3.144853, 3.145883, 3.146912, 3.147941, 3.148971, 3.15, 3.15, 3.15]

NOM_RES = 10000
SER_RES = 9820
TEMP_NOM = 25
NUM_SAMPLES = 25
THERM_B_COEFF = 3950
ADC_MAX = 1023
ADC_Vmax = 3.15

def init_temp_sensor(TENP_SENS_ADC_PIN_NO = 32):
    adc = ADC(Pin(TENP_SENS_ADC_PIN_NO))
    adc.atten(ADC.ATTN_11DB)
    adc.width(ADC.WIDTH_10BIT)
    return adc

def read_temp(temp_sens):
    raw_read = []
    # Collect NUM_SAMPLES
    for i in range(1, NUM_SAMPLES+1):
        raw_read.append(temp_sens.read())

    # Average of the NUM_SAMPLES and look it up in the table
    raw_average = sum(raw_read)/NUM_SAMPLES
    print('raw_avg = ' + str(raw_average))
    print('V_measured = ' + str(adc_V_lookup[round(raw_average)]))

    # Convert to resistance
    raw_average = ADC_MAX * adc_V_lookup[round(raw_average)]/ADC_Vmax
    resistance = (SER_RES * raw_average) / (ADC_MAX - raw_average)
    print('Thermistor resistance: {} ohms'.format(resistance))

    # Convert to temperature
    steinhart  = log(resistance / NOM_RES) / THERM_B_COEFF
    steinhart += 1.0 / (TEMP_NOM + 273.15)
    steinhart  = (1.0 / steinhart) - 273.15
    return steinhart

print("I'm alive!\n")
utime.sleep_ms(2000)

temp_sens = init_temp_sensor()

sample_last_ms = 0
SAMPLE_INTERVAL = 1000

while (True):
    if utime.ticks_diff(utime.ticks_ms(), sample_last_ms) >= SAMPLE_INTERVAL:
        temp = read_temp(temp_sens)
        print('Thermistor temperature: ' + str(temp))
        sample_last_ms = utime.ticks_ms()